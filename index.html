<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°åŒºè¡—é“åŠäº‹å¤„æŸ¥è¯¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ˜ï¸ è¡—é“åŠäº‹å¤„æŸ¥è¯¢</h1>
            <p class="subtitle">è€äººåŠäº‹å¥½å¸®æ‰‹ Â· æŸ¥å°åŒº çŸ¥è¡—é“</p>
        </header>

        <main>
            <div class="search-panel">
                <div class="step-indicator">ğŸ‘‰ ç¬¬ä¸€æ­¥ï¼šå¤åˆ¶æ”¶è´§äººä¿¡æ¯åˆ°è¿™é‡Œ</div>
                <div class="form-group">
                    <textarea id="address-input" class="smart-textarea large-text" rows="5"
                        placeholder="ä¾‹å¦‚ï¼š\nå¼ ä¸‰ 13800000000\nåŒ—äº¬å¸‚æœé˜³åŒºä¸‰é‡Œå±¯è¡—é“12å·æ¥¼"></textarea>
                </div>

                <div class="action-area">
                    <!-- Added onclick to guarantee execution -->
                    <button id="smart-search-btn" class="search-btn large-text" onclick="handleSmartSearch()">
                        ğŸ” æ™ºèƒ½è¯†åˆ«å¹¶æŸ¥è¯¢
                    </button>
                    <button id="clear-text-btn" class="secondary-btn" style="background:#bdbdbd; margin-top:10px;"
                        onclick="resetForm()">
                        æ¸…ç©ºå†…å®¹
                    </button>
                </div>

                <!-- Analysis Result Preview -->
                <div id="analysis-result" class="analysis-card" style="display: none;">
                    <h4>ğŸ¤– è¯†åˆ«ç»“æœï¼š</h4>
                    <div class="tags-container">
                        <span id="res-province" class="tag region">çœä»½?</span>
                    </div>
                    <div class="detail-text">
                        <strong>æœç´¢å…³é”®è¯ï¼š</strong> <span id="res-keyword">--</span>
                    </div>
                </div>
            </div>

            <div class="results-section" id="results-section" style="display: none;" aria-live="polite">
                <h2>æŸ¥è¯¢ç»“æœ</h2>
                <div id="loading-spinner" class="spinner" style="display: none;">æ­£åœ¨æŸ¥è¯¢è¯·ç¨å€™...</div>
                <div id="results-container"></div>
            </div>

            <div class="info-section">
                <h3>ğŸ’¡ ä½¿ç”¨å¸®åŠ©</h3>
                <ul>
                    <li>1. å°†åŒ…å«åœ°å€çš„ä¿¡æ¯ï¼ˆå¦‚ï¼šâ€œå§“å ç”µè¯ åœ°å€â€ï¼‰ç›´æ¥ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†ã€‚</li>
                    <li>2. ç‚¹å‡»è“è‰²çš„â€œæ™ºèƒ½è¯†åˆ«å¹¶æŸ¥è¯¢â€æŒ‰é’®ã€‚</li>
                    <li>3. ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«åœ°å€å¹¶æ˜¾ç¤ºå¯¹åº”çš„è¡—é“åŠäº‹å¤„ã€‚</li>
                </ul>
            </div>
        </main>
    </div>

    <!-- 1. Security Config (MUST BE FIRST) -->
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: 'ed2bdf69fa5c9278662ea8d7500a29c1',
        };
    </script>

    <!-- 2. Load AMap Loader -->
    <script src="https://webapi.amap.com/loader.js"></script>

    <!-- 3. Application Logic (Inline) -->
    <script type="text/javascript">
        // --- Configuration ---
        const JS_API_KEY = '3adde9a29c5e3f2482f52b6a320423c5';

        // --- State ---
        let provinceList = [];
        let placeSearch = null;
        let geocoder = null;

        // --- Initialization ---
        // Run immediately to ensure global functions are available
        console.log('Inline Script Loaded');

        async function initApp() {
            try {
                // Load Admin Data
                try {
                    const res = await fetch('admin-data/province.json');
                    provinceList = await res.json();
                } catch (e) { console.warn('Local admin data missing', e); }

                // Init Map
                if (typeof AMapLoader === 'undefined') {
                    alert('âŒ ä¸¥é‡é”™è¯¯ï¼šåœ°å›¾åŠ è½½å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚');
                    return;
                }

                const AMap = await AMapLoader.load({
                    key: JS_API_KEY,
                    version: "2.0",
                    plugins: ['AMap.PlaceSearch', 'AMap.Geocoder'],
                });

                placeSearch = new AMap.PlaceSearch({
                    pageSize: 10,
                    pageIndex: 1,
                    extensions: 'all',
                });

                geocoder = new AMap.Geocoder({
                    radius: 1000,
                    extensions: "all"
                });
                console.log('AMap Services Initialized');

            } catch (e) {
                console.error('Init Error:', e);
                alert('åœ°å›¾ç»„ä»¶åˆå§‹åŒ–å¤±è´¥: ' + e.message);
            }
        }

        // --- Main Logic ---
        // Exposed globally for onclick
        window.handleSmartSearch = function () {
            const addressInput = document.getElementById('address-input');
            const text = addressInput.value.trim();

            if (!text) { alert('è¯·å…ˆè¾“å…¥åœ°å€'); return; }

            setLoadingState(true);

            // 1. Parse
            const parsingObj = parseAddress(text);
            updateAnalysisUI(parsingObj);

            // 2. Check Init
            if (!placeSearch || !geocoder) {
                alert('åœ°å›¾ç»„ä»¶æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•...');
                setLoadingState(false);
                // Try init again just in case
                initApp();
                return;
            }

            if (parsingObj.province) {
                placeSearch.setCity(parsingObj.province.name);
            } else {
                placeSearch.setCity('å…¨å›½');
            }

            // Safety Timeout
            const safetyTimer = setTimeout(() => {
                if (document.getElementById('loading-spinner').style.display !== 'none') {
                    alert('æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚');
                    setLoadingState(false);
                }
            }, 10000);

            // 3. Search
            placeSearch.search(parsingObj.keyword, (status, result) => {
                clearTimeout(safetyTimer);
                if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                    processPoisAndDisplay(result.poiList.pois);
                    setLoadingState(false);
                } else {
                    // Fallback to Geocoding
                    geocoder.getLocation(parsingObj.keyword, (status, result) => {
                        clearTimeout(safetyTimer);
                        if (status === 'complete' && result.geocodes.length > 0) {
                            const geo = result.geocodes[0];
                            const mockPoi = {
                                name: "ğŸ“ åœ°å€ç²¾ç¡®åŒ¹é…",
                                address: geo.formattedAddress,
                                location: geo.location
                            };
                            processPoisAndDisplay([mockPoi]);
                        } else {
                            showNoResults();
                        }
                        setLoadingState(false);
                    });
                }
            });
        };

        window.resetForm = function () {
            document.getElementById('address-input').value = '';
            document.getElementById('analysis-result').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
        };

        // --- Helpers ---
        async function processPoisAndDisplay(pois) {
            const resultsContainer = document.getElementById('results-container');
            const loadingSpinner = document.getElementById('loading-spinner');

            const cardsHtml = await Promise.all(pois.map(async (poi) => {
                const adminInfo = await getRegeoAdminInfo(poi.location);
                return `
                    <div class="result-card">
                        <h3>${poi.name}</h3>
                        <div class="info-item"><strong>ğŸ“ åœ°å€ï¼š</strong>${poi.address || poi.name}</div>
                        <div class="info-item">
                            <strong>ğŸ›ï¸ è¡—é“åŠäº‹å¤„ï¼š</strong><br>
                            <span class="highlight-street">${adminInfo.streetOffice}</span>
                        </div>
                        <div class="info-item" style="font-size:12px; color:#aaa; margin-top:5px;">
                            è¡Œæ”¿åŒºåˆ’ä»£ç ï¼š${adminInfo.adcode || '--'}
                        </div>
                    </div>
                `;
            }));

            resultsContainer.innerHTML = cardsHtml.join('');
            loadingSpinner.style.display = 'none';
        }

        function getRegeoAdminInfo(location) {
            return new Promise((resolve) => {
                geocoder.getAddress(location, (status, result) => {
                    if (status === 'complete' && result.regeocode) {
                        const comp = result.regeocode.addressComponent;
                        let township = comp.township;
                        let display = 'æš‚æ— æ˜ç¡®è¡—é“ä¿¡æ¯';
                        if (township && typeof township === 'string' && township.trim()) {
                            if (township.endsWith('åŠäº‹å¤„')) display = township;
                            else if (township.endsWith('è¡—é“') || township.endsWith('é•‡') || township.endsWith('ä¹¡')) display = township + 'åŠäº‹å¤„';
                            else display = township + 'è¡—é“åŠäº‹å¤„';
                        } else {
                            display = `${comp.district || ''} (æœªåŒ¹é…)`;
                        }
                        resolve({ streetOffice: display, adcode: comp.adcode });
                    } else {
                        resolve({ streetOffice: 'æŸ¥è¯¢å¤±è´¥', adcode: '' });
                    }
                });
            });
        }

        function parseAddress(text) {
            let cleanText = text.replace(/(\+?86)?\s?1[3-9]\d{9}/g, ' ');
            const noiseWords = ['æ”¶è´§äºº', 'å§“å', 'ç”µè¯', 'æ‰‹æœº', 'è”ç³»æ–¹å¼', 'åœ°å€', 'æ‰€åœ¨åœ°åŒº', 'è¯¦ç»†åœ°å€', 'Default', 'ï¼š', ':', ',', 'ï¼Œ', 'ã€‚'];
            noiseWords.forEach(word => cleanText = cleanText.replaceAll(word, ' '));
            cleanText = cleanText.replace(/\s+/g, ' ').trim();

            let foundProvince = null;
            for (const p of provinceList) {
                if (cleanText.includes(p.name)) { foundProvince = p; break; }
            }
            return { province: foundProvince, keyword: cleanText };
        }

        function updateAnalysisUI(parsed) {
            document.getElementById('analysis-result').style.display = 'block';
            document.getElementById('res-province').innerText = parsed.province ? parsed.province.name : 'è‡ªåŠ¨èŒƒå›´';
            document.getElementById('res-keyword').innerText = parsed.keyword;
        }

        function setLoadingState(isLoading) {
            const btn = document.getElementById('smart-search-btn');
            const spinner = document.getElementById('loading-spinner');
            const section = document.getElementById('results-section');
            const container = document.getElementById('results-container');

            if (isLoading) {
                btn.disabled = true;
                btn.innerText = 'ğŸ” æŸ¥è¯¢ä¸­...';
                section.style.display = 'block';
                container.innerHTML = '';
                spinner.style.display = 'block';
            } else {
                btn.disabled = false;
                btn.innerText = 'ğŸ” æ™ºèƒ½è¯†åˆ«å¹¶æŸ¥è¯¢';
            }
        }

        function showNoResults() {
            document.getElementById('results-container').innerHTML = '<div class="no-results">ğŸ˜• æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
        }

        // Start App
        initApp();

    </script>
</body>

</html>